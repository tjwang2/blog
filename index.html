<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸ªäººåšå®¢</title>
    <style>
        /* åŸæœ‰æ ·å¼ä¿ç•™ï¼Œç§»é™¤è¯­éŸ³è¾“å…¥ç›¸å…³æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }

        /* é¡µé¢å…¨å±é€‚é…æ ¸å¿ƒæ ·å¼ */
        body {
            width: 100vw;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            background-color: #f5f5f5;
        }

        .container {
            width: 100%; /* æ’‘æ»¡å®½åº¦ */
            max-width: 100%; /* å–æ¶ˆæœ€å¤§å®½åº¦é™åˆ¶ */
            margin: 0 auto;
            padding: 20px; /* ä¿ç•™å†…è¾¹è·é¿å…å†…å®¹è´´è¾¹ */
        }

        /* å¤§å±è®¾å¤‡ä¼˜åŒ–ï¼ˆå®½åº¦>1200pxæ—¶ï¼‰ */
        @media (min-width: 1200px) {
            .container {
                max-width: 1200px; /* å¤§å±ä¸‹é™åˆ¶æœ€å¤§å®½åº¦é¿å…å†…å®¹è¿‡å®½ */
                padding: 20px 0;
            }
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        /* é‡æ„é¡¶éƒ¨ç­›é€‰åŒºåŸŸ - ä¸¤åˆ—å¸ƒå±€ */
        .top-filter-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%; /* ç¡®ä¿æ’‘æ»¡å®¹å™¨ */
        }

        /* å·¦åˆ—ï¼šæ—¥æœŸç­›é€‰ */
        .filter-col-left {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* å³åˆ—ï¼šæœç´¢+å¯¼å‡º */
        .filter-col-right {
            flex: 1;
            min-width: 280px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-col-title {
            color: #555;
            font-size: 1rem;
            font-weight: bold;
            white-space: nowrap;
        }

        /* æ—¥æœŸç­›é€‰è¡Œ */
        .date-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            flex: 1;
            min-width: 120px;
        }

        .range-text {
            color: #666;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        #date-search-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            min-width: 80px;
        }

        /* æœç´¢+å¯¼å‡ºè¡Œ */
        .search-export-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        #search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 180px;
        }

        #search-btn {
            padding: 8px 16px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            min-width: 100px;
        }

        #search-btn:hover {
            background: #218838;
        }

        #export-btn {
            padding: 8px 16px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            min-width: 100px;
        }

        #export-btn:hover {
            background: #138496;
        }

        .tags-area {
            margin-bottom: 20px;
            width: 100%;
        }

        .tags-area h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .tag-item {
            display: inline-block;
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 20px;
            margin-right: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #495057;
        }

        .tag-item.active {
            background: #007bff;
            color: white;
        }

        /* å¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª— */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .export-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .export-modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .export-format-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .export-format-item input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .export-modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .export-confirm-btn {
            padding: 8px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .export-cancel-btn {
            padding: 8px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .form-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%; /* ç¡®ä¿è¡¨å•æ’‘æ»¡å®½åº¦ */
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
        }

        textarea {
            min-height: 150px;
            line-height: 1.5;
        }

        #publish-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        #publish-btn:hover {
            background: #0056b3;
        }

        .edit-tip {
            color: #ffc107;
            font-weight: 500;
            margin-bottom: 15px;
            padding: 8px;
            background: #fff8e1;
            border-radius: 4px;
        }

        #cancel-edit-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
        }

        #cancel-edit-btn:hover {
            background: #5a6268;
        }

        .no-result {
            text-align: center;
            color: #999;
            padding: 10px 20px;
            font-size: 1rem;
        }

        .logs-area {
            width: 100%;
        }

        .logs-area h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .log-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative;
            width: 100%;
        }

        /* å¢¨æ°´å±é€‚é… - æ—¥å¿—æ ‡é¢˜åŠ ç²—åŠ é»‘ */
        .log-item h3 {
            color: #000;
            font-weight: 900; /* åŠ ç²—åŠ é»‘ */
            margin-bottom: 8px;
        }

        /* å¢¨æ°´å±é€‚é… - æ ‡ç­¾æ–‡å­—åŠ ç²— */
        .log-item .log-tags {
            color: #000;
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        /* å¢¨æ°´å±é€‚é… - æ­£æ–‡åŠ ç²—+1.5å€è¡Œè· */
        .log-item .log-content {
            color: #000;
            font-weight: bold; /* åŠ ç²— */
            line-height: 1.5; /* 1.5å€è¡Œè· */
            margin: 10px 0;
            white-space: pre-line;
        }

        /* å¢¨æ°´å±é€‚é… - æ—¶é—´æ–‡å­—åŠ ç²— */
        .log-item .log-time {
            color: #000;
            font-weight: bold;
            font-size: 0.85rem;
            text-align: right;
            margin-top: 10px;
        }

        /* ç¼–è¾‘/åˆ é™¤æŒ‰é’®æ ·å¼ */
        .log-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .edit-btn {
            padding: 4px 8px;
            background: #ffc107;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .edit-btn:hover {
            background: #ffca2c;
        }

        .delete-btn {
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-btn:hover {
            background: #e55361;
        }
    </style>
    <!-- å¯¼å‡ºæ‰€éœ€ç¬¬ä¸‰æ–¹åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epub-gen@0.1.19/dist/epub-gen.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„ä¸ªäººåšå®¢</h1>

        <!-- é‡æ„é¡¶éƒ¨ç­›é€‰åŒºåŸŸ - ä¸¤åˆ—å¸ƒå±€ -->
        <div class="top-filter-wrapper">
            <!-- å·¦åˆ—ï¼šæ—¥æœŸç­›é€‰ -->
            <div class="filter-col-left">
                <div class="filter-col-title">æ—¥å¿—ç­›é€‰</div>
                <div class="date-filter-row">
                    <input type="date" id="start-date" class="date-input" placeholder="å¼€å§‹æ—¥æœŸ">
                    <span class="range-text">è‡³</span>
                    <input type="date" id="end-date" class="date-input" placeholder="ç»“æŸæ—¥æœŸ">
                    <button id="date-search-btn">æŸ¥æ‰¾</button>
                </div>
            </div>

            <!-- å³åˆ—ï¼šæœç´¢+å¯¼å‡º -->
            <div class="filter-col-right">
                <div class="filter-col-title">å…¨æ–‡æ£€ç´¢</div>
                <div class="search-export-row">
                    <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æ£€ç´¢æ—¥å¿—ï¼ˆæ ‡é¢˜/æ­£æ–‡ï¼‰...">
                    <button id="search-btn">å…¨æ–‡æ£€ç´¢</button>
                    <button id="export-btn">ğŸ“¤ ä¸€é”®å¯¼å‡º</button>
                </div>
            </div>
        </div>

        <div class="tags-area">
            <h3>æŒ‰æ ‡ç­¾ç­›é€‰æ—¥å¿—</h3>
            <div id="tag-list" class="tag-container"></div>
        </div>

        <!-- å¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª— -->
        <div class="export-modal" id="export-modal">
            <div class="export-modal-content">
                <h3>é€‰æ‹©å¯¼å‡ºæ ¼å¼</h3>
                <div class="export-format-item">
                    <input type="radio" name="export-format" id="format-txt" value="txt" checked>
                    <label for="format-txt">TXT çº¯æ–‡æœ¬</label>
                </div>
                <div class="export-format-item">
                    <input type="radio" name="export-format" id="format-pdf" value="pdf">
                    <label for="format-pdf">PDF æ–‡æ¡£ï¼ˆç›®å½•ä¸å¯ç‚¹å‡»ï¼‰</label>
                </div>
                <div class="export-format-item">
                    <input type="radio" name="export-format" id="format-epub" value="epub">
                    <label for="format-epub">EPUB ç”µå­ä¹¦ï¼ˆç›®å½•å¯ç‚¹å‡»ï¼‰</label>
                </div>
                <div class="export-modal-btns">
                    <button class="export-confirm-btn" id="export-confirm-btn">ç¡®è®¤å¯¼å‡º</button>
                    <button class="export-cancel-btn" id="export-cancel-btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div class="form-area">
            <h2>å‘å¸ƒæ–°æ—¥å¿—</h2>
            <!-- ç¼–è¾‘æç¤º -->
            <div class="edit-tip" id="edit-tip" style="display: none;">ğŸ“ æ­£åœ¨ç¼–è¾‘æ—¥å¿—ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»ã€Œæ›´æ–°æ—¥å¿—ã€</div>
            <div class="form-group">
                <label for="log-title">æ—¥å¿—æ ‡é¢˜</label>
                <input type="text" id="log-title" placeholder="è¾“å…¥æ—¥å¿—æ ‡é¢˜...">
            </div>
            <div class="form-group">
                <label for="log-content">æ—¥å¿—å†…å®¹</label>
                <textarea id="log-content" placeholder="è¾“å…¥æ—¥å¿—å†…å®¹...ï¼ˆæ•²å›è½¦å¯åˆ†æ®µï¼‰"></textarea>
            </div>
            <div class="form-group">
                <label for="log-tags">æ—¥å¿—æ ‡ç­¾ï¼ˆå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="log-tags" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»,å­¦ä¹ ,å·¥ä½œ...">
            </div>
            <button id="publish-btn">å‘å¸ƒæ—¥å¿—</button>
            <!-- å–æ¶ˆç¼–è¾‘æŒ‰é’® -->
            <button id="cancel-edit-btn" style="display: none;">å–æ¶ˆç¼–è¾‘</button>
        </div>

        <div class="logs-area">
            <h2>æˆ‘çš„æ—¥å¿—åˆ—è¡¨</h2>
            <div id="logs-list"></div>
        </div>
    </div>

    <script>
        // localStorageè¯»å–æ·»åŠ å®¹é”™
        let logs = [];
        try {
            logs = JSON.parse(localStorage.getItem('personalBlogLogs')) || [];
            logs = logs.map(log => ({ 
                tags: [], 
                time: log.time || new Date().toLocaleString(),
                date: log.date || new Date(log.time || new Date()).toISOString().split('T')[0],
                ...log 
            }));
        } catch (e) {
            console.error('è¯»å–æœ¬åœ°æ—¥å¿—å¤±è´¥ï¼š', e);
            logs = [];
        }

        // æ ¸å¿ƒDOMå…ƒç´ 
        const publishBtn = document.getElementById('publish-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editTip = document.getElementById('edit-tip');
        const logTitle = document.getElementById('log-title');
        const logContent = document.getElementById('log-content');
        const logTags = document.getElementById('log-tags');
        const logsList = document.getElementById('logs-list');
        const tagList = document.getElementById('tag-list');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dateSearchBtn = document.getElementById('date-search-btn');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');

        // å¯¼å‡ºç›¸å…³DOM
        const exportBtn = document.getElementById('export-btn');
        const exportModal = document.getElementById('export-modal');
        const exportConfirmBtn = document.getElementById('export-confirm-btn');
        const exportCancelBtn = document.getElementById('export-cancel-btn');

        // å½“å‰æ¸²æŸ“çš„æ—¥å¿—ï¼ˆç”¨äºå¯¼å‡ºï¼‰
        let currentRenderedLogs = logs;
        // å½“å‰ç¼–è¾‘çš„æ—¥å¿—ç´¢å¼•
        let editingIndex = -1;

        // ========== æ ¸å¿ƒåŠŸèƒ½é€»è¾‘ ==========
        // ç¼–è¾‘æ—¥å¿—å‡½æ•°
        function editLog(index) {
            editingIndex = index;
            const log = logs[index];
            // å¡«å……è¡¨å•
            logTitle.value = log.title;
            logContent.value = log.content;
            logTags.value = log.tags.join(',');
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            publishBtn.textContent = 'æ›´æ–°æ—¥å¿—';
            cancelEditBtn.style.display = 'inline-block';
            editTip.style.display = 'block';
            // æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
            document.querySelector('.form-area').scrollIntoView({ behavior: 'smooth' });
        }

        // åˆ é™¤æ—¥å¿—å‡½æ•°
        function deleteLog(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥å¿—å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
                logs.splice(index, 1);
                localStorage.setItem('personalBlogLogs', JSON.stringify(logs));
                renderLogs(logs);
                renderTags();
                alert('æ—¥å¿—å·²æˆåŠŸåˆ é™¤ï¼');
            }
        }

        // å–æ¶ˆç¼–è¾‘å‡½æ•°
        function cancelEdit() {
            editingIndex = -1;
            // æ¸…ç©ºè¡¨å•
            logTitle.value = '';
            logContent.value = '';
            logTags.value = '';
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            publishBtn.textContent = 'å‘å¸ƒæ—¥å¿—';
            cancelEditBtn.style.display = 'none';
            editTip.style.display = 'none';
        }

        // å‘å¸ƒ/æ›´æ–°æ—¥å¿—å‡½æ•°
        function publishLog() {
            const title = logTitle.value.trim();
            const content = logContent.value.trim();
            const tagsStr = logTags.value.trim();
            
            if (!title || !content) {
                alert('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            const tags = tagsStr ? tagsStr.split(',').map(tag => tag.trim()) : [];
            
            // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰æ—¥å¿—
            if (editingIndex >= 0) {
                logs[editingIndex] = {
                    ...logs[editingIndex],
                    title: title,
                    content: content,
                    tags: tags
                };
                alert('æ—¥å¿—å·²æˆåŠŸæ›´æ–°ï¼');
                cancelEdit();
            } 
            // å‘å¸ƒæ¨¡å¼ï¼šæ–°å¢æ—¥å¿—
            else {
                const now = new Date();
                const newLog = {
                    title: title,
                    content: content,
                    tags: tags,
                    time: now.toLocaleString(),
                    date: now.toISOString().split('T')[0]
                };
                logs.unshift(newLog);
                alert('æ—¥å¿—å‘å¸ƒæˆåŠŸï¼');
                // æ¸…ç©ºè¡¨å•
                logTitle.value = '';
                logContent.value = '';
                logTags.value = '';
            }

            localStorage.setItem('personalBlogLogs', JSON.stringify(logs));
            renderLogs(logs);
            renderTags();
        }

        // æŒ‰æ—¥æœŸç­›é€‰æ—¥å¿—
        function filterLogsByDate() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate && !endDate) {
                renderLogs(logs);
                return;
            }

            const filteredLogs = logs.filter(log => {
                const logDate = log.date;
                if (startDate && !endDate) {
                    return logDate === startDate;
                } else if (!startDate && endDate) {
                    return logDate === endDate;
                } else {
                    return logDate >= startDate && logDate <= endDate;
                }
            });

            renderLogs(filteredLogs);
        }

        // æ¸²æŸ“æ ‡ç­¾åˆ—è¡¨
        function renderTags() {
            const allTags = [...new Set(logs.flatMap(log => log.tags))];
            tagList.innerHTML = '';
            allTags.forEach(tag => {
                const tagItem = document.createElement('div');
                tagItem.className = 'tag-item';
                tagItem.textContent = tag;
                tagItem.addEventListener('click', () => {
                    document.querySelectorAll('.tag-item').forEach(item => item.classList.remove('active'));
                    tagItem.classList.add('active');
                    const filteredLogs = logs.filter(log => log.tags.includes(tag));
                    renderLogs(filteredLogs);
                });
                tagList.appendChild(tagItem);
            });
        }

        // å…³é”®è¯æœç´¢æ—¥å¿—
        function searchLogs() {
            const keyword = searchInput.value.trim().toLowerCase();
            if (!keyword) {
                renderLogs(logs);
                return;
            }
            const filteredLogs = logs.filter(log => {
                const titleMatch = log.title.toLowerCase().includes(keyword);
                const contentMatch = log.content.toLowerCase().includes(keyword);
                return titleMatch || contentMatch;
            });
            renderLogs(filteredLogs);
        }

        // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
        function renderLogs(logsToRender) {
            currentRenderedLogs = logsToRender;
            
            if (logsToRender.length === 0) {
                logsList.innerHTML = '<div class="no-result">æš‚æ— æ—¥å¿—æ•°æ®</div>';
                return;
            }

            let logsHtml = '';
            logsToRender.forEach((log, index) => {
                // æ‰¾åˆ°åŸå§‹æ•°ç»„ä¸­çš„ç´¢å¼•
                const originalIndex = logs.findIndex(item => 
                    item.title === log.title && 
                    item.time === log.time && 
                    item.content === log.content
                );
                logsHtml += `
                    <div class="log-item">
                        <div class="log-actions">
                            <button class="edit-btn" onclick="editLog(${originalIndex})">ç¼–è¾‘</button>
                            <button class="delete-btn" onclick="deleteLog(${originalIndex})">åˆ é™¤</button>
                        </div>
                        <h3>${log.title}</h3>
                        <div class="log-tags">æ ‡ç­¾ï¼š${log.tags.join('ã€') || 'æ— '}</div>
                        <div class="log-content">${log.content}</div>
                        <div class="log-time">å‘å¸ƒæ—¶é—´ï¼š${log.time}</div>
                    </div>
                `;
            });
            logsList.innerHTML = logsHtml;
        }

        // ========== å¯¼å‡ºåŠŸèƒ½é€»è¾‘ ==========
        // æ‰“å¼€å¯¼å‡ºå¼¹çª—
        exportBtn.addEventListener('click', () => {
            if (currentRenderedLogs.length === 0) {
                alert('æš‚æ— å¯å¯¼å‡ºçš„æ—¥å¿—æ•°æ®ï¼');
                return;
            }
            exportModal.style.display = 'flex';
        });

        // å…³é—­å¯¼å‡ºå¼¹çª—
        exportCancelBtn.addEventListener('click', () => {
            exportModal.style.display = 'none';
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        exportModal.addEventListener('click', (e) => {
            if (e.target === exportModal) {
                exportModal.style.display = 'none';
            }
        });

        // ç¡®è®¤å¯¼å‡º
        exportConfirmBtn.addEventListener('click', () => {
            const selectedFormat = document.querySelector('input[name="export-format"]:checked').value;
            exportModal.style.display = 'none';
            
            switch (selectedFormat) {
                case 'txt':
                    exportAsTXT();
                    break;
                case 'pdf':
                    exportAsPDF();
                    break;
                case 'epub':
                    exportAsEPUB();
                    break;
            }
        });

        // å¯¼å‡ºä¸ºTXT
        function exportAsTXT() {
            let content = '===== æ—¥å¿—ç›®å½• =====\n';
            currentRenderedLogs.forEach((log, index) => {
                content += `${index + 1}. ${log.title}\n`;
            });

            content += '\n===== æ—¥å¿—æ­£æ–‡ =====\n\n';
            currentRenderedLogs.forEach((log, index) => {
                content += `ã€${index + 1}ã€‘${log.title}\n`;
                content += `æ ‡ç­¾ï¼š${log.tags.join('ã€') || 'æ— '}\n`;
                content += `å‘å¸ƒæ—¶é—´ï¼š${log.time}\n`;
                content += `å†…å®¹ï¼š\n${log.content}\n\n`;
                content += '-------------------------\n\n';
            });

            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            saveAs(blob, `æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}.txt`);
        }

        // å¯¼å‡ºä¸ºPDF
        function exportAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // è®¾ç½®å­—ä½“ï¼ˆè§£å†³ä¸­æ–‡æ˜¾ç¤ºé—®é¢˜ï¼‰
            pdf.setFont('simhei', 'normal');
            pdf.setFontSize(16);
            pdf.text('æˆ‘çš„åšå®¢æ—¥å¿—', 95, 20, { align: 'center' });

            // ç›®å½•éƒ¨åˆ†
            pdf.setFontSize(14);
            pdf.text('===== æ—¥å¿—ç›®å½• =====', 20, 40);
            let yPos = 50;
            currentRenderedLogs.forEach((log, index) => {
                if (yPos > 280) {
                    pdf.addPage();
                    yPos = 20;
                }
                pdf.text(`${index + 1}. ${log.title}`, 25, yPos);
                yPos += 10;
            });

            // æ­£æ–‡éƒ¨åˆ†
            pdf.addPage();
            pdf.setFontSize(14);
            pdf.text('===== æ—¥å¿—æ­£æ–‡ =====', 20, 20);
            yPos = 30;

            currentRenderedLogs.forEach((log, index) => {
                if (yPos > 280) {
                    pdf.addPage();
                    yPos = 20;
                }
                // æ ‡é¢˜
                pdf.setFontSize(12);
                pdf.text(`ã€${index + 1}ã€‘${log.title}`, 20, yPos);
                yPos += 8;
                // æ ‡ç­¾å’Œæ—¶é—´
                pdf.setFontSize(10);
                pdf.text(`æ ‡ç­¾ï¼š${log.tags.join('ã€') || 'æ— '} | å‘å¸ƒæ—¶é—´ï¼š${log.time}`, 20, yPos);
                yPos += 8;
                // å†…å®¹ï¼ˆåˆ†è¡Œå¤„ç†ï¼‰
                pdf.setFontSize(10);
                const contentLines = pdf.splitTextToSize(log.content, 170);
                pdf.text(contentLines, 20, yPos);
                yPos += contentLines.length * 6 + 10;
                // åˆ†éš”çº¿
                pdf.setLineWidth(0.1);
                pdf.line(20, yPos, 190, yPos);
                yPos += 10;
            });

            // ä¸‹è½½PDF
            pdf.save(`æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}.pdf`);
        }

        // å¯¼å‡ºä¸ºEPUB
        function exportAsEPUB() {
            const epubOptions = {
                title: `æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}`,
                author: 'ä¸ªäººåšå®¢',
                publisher: 'ä¸ªäººåšå®¢ç³»ç»Ÿ',
                lang: 'zh-CN',
                content: []
            };

            // ç›®å½•é¡µ
            let tocContent = '<h1>æ—¥å¿—ç›®å½•</h1><ul>';
            currentRenderedLogs.forEach((log, index) => {
                tocContent += `<li><a href="#log-${index}">${index + 1}. ${log.title}</a></li>`;
            });
            tocContent += '</ul>';

            epubOptions.content.push({
                title: 'ç›®å½•',
                data: tocContent
            });

            // æ­£æ–‡é¡µ
            currentRenderedLogs.forEach((log, index) => {
                const logContent = `
                    <div id="log-${index}">
                        <h2>${index + 1}. ${log.title}</h2>
                        <p><strong>æ ‡ç­¾ï¼š</strong>${log.tags.join('ã€') || 'æ— '}</p>
                        <p><strong>å‘å¸ƒæ—¶é—´ï¼š</strong>${log.time}</p>
                        <div style="margin-top: 20px; line-height: 1.8;">${log.content.replace(/\n/g, '<br>')}</div>
                    </div>
                    <hr style="margin: 30px 0;">
                `;

                epubOptions.content.push({
                    title: log.title,
                    data: logContent
                });
            });

            // ç”ŸæˆEPUBå¹¶ä¸‹è½½
            const epubGenerator = new EpubGen(epubOptions);
            epubGenerator.generateEPUB().then((epubBlob) => {
                saveAs(epubBlob, `æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}.epub`);
            }).catch((err) => {
                alert(`EPUBå¯¼å‡ºå¤±è´¥ï¼š${err.message}`);
                console.error(err);
            });
        }

        // ========== äº‹ä»¶ç»‘å®š ==========
        publishBtn.addEventListener('click', publishLog);
        cancelEditBtn.addEventListener('click', cancelEdit);
        dateSearchBtn.addEventListener('click', filterLogsByDate);
        searchBtn.addEventListener('click', searchLogs);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLogs();
        });

        // å…¨å±€é”™è¯¯æ•è·ï¼ˆé¿å…å•ä¸ªåŠŸèƒ½æŠ¥é”™é˜»æ–­é¡µé¢ï¼‰
        window.addEventListener('error', (e) => {
            console.error('é¡µé¢æ‰§è¡Œé”™è¯¯ï¼š', e.message);
            renderLogs(logs);
            renderTags();
        });

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', () => {
            renderLogs(logs);
            renderTags();
        });

        // æš´éœ²å…¨å±€å‡½æ•°
        window.editLog = editLog;
        window.deleteLog = deleteLog;
    </script>
</body>
</html>
