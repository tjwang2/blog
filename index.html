<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸ªäººåšå®¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .calendar-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .calendar-area h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .range-text {
            color: #666;
            font-size: 0.9rem;
        }

        #date-search-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .tags-area {
            margin-bottom: 20px;
        }

        .tags-area h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .tag-item {
            display: inline-block;
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 20px;
            margin-right: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #495057;
        }

        .tag-item.active {
            background: #007bff;
            color: white;
        }

        .search-area {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        #search-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        #search-btn:hover {
            background: #218838;
        }

        .form-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
        }

        textarea {
            min-height: 150px;
            line-height: 1.5;
        }

        #publish-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        #publish-btn:hover {
            background: #0056b3;
        }

        .voice-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }

        .voice-btn:hover {
            background: #eee;
        }

        .voice-btn.recording {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fecdd3;
        }

        #voice-status {
            font-size: 0.85rem;
            margin-left: 10px;
            color: #999;
            vertical-align: middle;
        }

        .voice-status.error {
            color: #dc2626;
            font-weight: 500;
        }

        .voice-status.tip {
            color: #007bff;
            font-weight: 500;
        }

        .logs-area h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .log-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .log-item h3 {
            color: #007bff;
            margin-bottom: 8px;
        }

        .log-item .log-tags {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .log-item .log-content {
            color: #555;
            line-height: 1.8;
            margin: 10px 0;
            white-space: pre-line;
        }

        .log-item .log-time {
            color: #999;
            font-size: 0.85rem;
            text-align: right;
        }

        .no-result {
            text-align: center;
            color: #999;
            padding: 10px 20px;
            font-size: 1rem;
        }

        .env-tip {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #0c5460;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„ä¸ªäººåšå®¢</h1>

        <div class="calendar-area">
            <h3>æŒ‰æ—¥æœŸ/æ—¶é—´æ®µæŸ¥æ‰¾æ—¥å¿—</h3>
            <div class="date-range">
                <input type="date" id="start-date" class="date-input" placeholder="å¼€å§‹æ—¥æœŸ">
                <span class="range-text">è‡³</span>
                <input type="date" id="end-date" class="date-input" placeholder="ç»“æŸæ—¥æœŸ">
                <button id="date-search-btn">æŸ¥æ‰¾</button>
            </div>
        </div>

        <div class="tags-area">
            <h3>æŒ‰æ ‡ç­¾ç­›é€‰æ—¥å¿—</h3>
            <div id="tag-list" class="tag-container">
            </div>
        </div>

        <div class="search-area">
            <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æ£€ç´¢æ—¥å¿—ï¼ˆæ ‡é¢˜/æ­£æ–‡ï¼‰...">
            <button id="search-btn">å…¨æ–‡æ£€ç´¢</button>
        </div>

        <div class="form-area">
            <h2>å‘å¸ƒæ–°æ—¥å¿—</h2>
            <div class="env-tip" id="env-tip">ğŸ“¢ è¯­éŸ³è¾“å…¥æç¤ºï¼š<br>1. ç”µè„‘ç«¯å»ºè®®ç”¨Chrome/Edgeæµè§ˆå™¨ï¼›<br>2. æ— éœ€è¯´æ ‡ç‚¹ï¼åœé¡¿çŸ­åŠ é€—å·ï¼Œåœé¡¿é•¿åŠ å¥å·ï¼›<br>3. è¯´å®Œæ‰‹åŠ¨ç‚¹å‡»åœæ­¢ï¼Œæ ‡ç‚¹æ›´ç²¾å‡†</div>
            <div class="form-group">
                <label for="log-title">æ—¥å¿—æ ‡é¢˜</label>
                <input type="text" id="log-title" placeholder="è¾“å…¥æ—¥å¿—æ ‡é¢˜...">
            </div>
            <div class="form-group">
                <label for="log-content">æ—¥å¿—å†…å®¹</label>
                <textarea id="log-content" placeholder="è¾“å…¥æ—¥å¿—å†…å®¹...ï¼ˆæ•²å›è½¦å¯åˆ†æ®µï¼‰"></textarea>
                <button type="button" id="voice-input-btn" class="voice-btn">
                    ğŸ™ï¸ è¯­éŸ³è¾“å…¥
                </button>
                <span id="voice-status"></span>
            </div>
            <div class="form-group">
                <label for="log-tags">æ—¥å¿—æ ‡ç­¾ï¼ˆå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="log-tags" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»,å­¦ä¹ ,å·¥ä½œ...">
            </div>
            <button id="publish-btn">å‘å¸ƒæ—¥å¿—</button>
        </div>

        <div class="logs-area">
            <h2>æˆ‘çš„æ—¥å¿—åˆ—è¡¨</h2>
            <div id="logs-list"></div>
        </div>
    </div>

    <script>
        // ========== åªéœ€è¦ä¿®æ”¹è¿™é‡Œçš„ä¸¤ä¸ªé…ç½®é¡¹ï¼ï¼ï¼ ==========
        const GIST_ID = '07ecf70971a4435dd86db5969367f8e5'; // ç¬¬ä¸€æ­¥ï¼šæ›¿æ¢æˆä½ çš„Gist ID
        const GITHUB_TOKEN = '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'; // ç¬¬äºŒæ­¥ï¼šæ›¿æ¢æˆä½ çš„GitHub Token
        const GIST_FILE_NAME = 'blog-logs.json';
        // ========== é…ç½®é¡¹ç»“æŸ ==========

        // å…¨å±€å˜é‡
        let logs = [];
        const publishBtn = document.getElementById('publish-btn');
        const logTitle = document.getElementById('log-title');
        const logContent = document.getElementById('log-content');
        const logTags = document.getElementById('log-tags');
        const logsList = document.getElementById('logs-list');
        const tagList = document.getElementById('tag-list');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dateSearchBtn = document.getElementById('date-search-btn');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const voiceStatus = document.getElementById('voice-status');
        const envTip = document.getElementById('env-tip');

        // ========== Gist åŒæ­¥æ ¸å¿ƒå‡½æ•° ==========
        // ä»Gistè·å–æ—¥å¿—
        async function fetchLogsFromGist() {
            try {
                // æ£€æŸ¥é…ç½®æ˜¯å¦å¡«å†™
                if (!GIST_ID || GIST_ID === 'æ›¿æ¢æˆä½ çš„Gist ID' || !GITHUB_TOKEN || GITHUB_TOKEN === 'æ›¿æ¢æˆä½ çš„GitHub Token') {
                    throw new Error('è¯·å…ˆå¡«å†™Gist IDå’ŒGitHub Tokené…ç½®é¡¹');
                }

                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Gistè¯·æ±‚å¤±è´¥ï¼š${response.status} - ${errorText}`);
                }
                
                const gist = await response.json();
                const logContent = gist.files[GIST_FILE_NAME].content;
                let gistLogs = JSON.parse(logContent || '[]');
                
                // å…¼å®¹æ•°æ®æ ¼å¼
                gistLogs = gistLogs.map(log => ({ 
                    tags: [], 
                    time: log.time || new Date().toLocaleString(),
                    date: log.date || new Date(log.time || new Date()).toISOString().split('T')[0],
                    ...log 
                }));
                
                // ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
                localStorage.setItem('personalBlogLogs', JSON.stringify(gistLogs));
                return gistLogs;
            } catch (err) {
                console.error('ä»GiståŠ è½½å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç¼“å­˜:', err);
                // é™çº§åˆ°æœ¬åœ°å­˜å‚¨
                const localLogs = JSON.parse(localStorage.getItem('personalBlogLogs')) || [];
                return localLogs.map(log => ({ 
                    tags: [], 
                    time: log.time || new Date().toLocaleString(),
                    date: log.date || new Date(log.time || new Date()).toISOString().split('T')[0],
                    ...log 
                }));
            }
        }

        // ä¿å­˜æ—¥å¿—åˆ°Gist
        async function saveLogsToGist(logs) {
            try {
                // æ£€æŸ¥é…ç½®æ˜¯å¦å¡«å†™
                if (!GIST_ID || GIST_ID === 'æ›¿æ¢æˆä½ çš„Gist ID' || !GITHUB_TOKEN || GITHUB_TOKEN === 'æ›¿æ¢æˆä½ çš„GitHub Token') {
                    throw new Error('è¯·å…ˆå¡«å†™Gist IDå’ŒGitHub Tokené…ç½®é¡¹');
                }

                // å…ˆè·å–æœ€æ–°çš„Gistç‰ˆæœ¬ï¼ˆé¿å…å†²çªï¼‰
                const getResponse = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getResponse.ok) {
                    const errorText = await getResponse.text();
                    throw new Error(`è·å–Gistå¤±è´¥ï¼š${getResponse.status} - ${errorText}`);
                }

                const gist = await getResponse.json();
                
                // æ›´æ–°Gistå†…å®¹
                const updateResponse = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            [GIST_FILE_NAME]: {
                                content: JSON.stringify(logs, null, 2)
                            }
                        }
                    })
                });
                
                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    throw new Error(`ä¿å­˜Gistå¤±è´¥ï¼š${updateResponse.status} - ${errorText}`);
                }

                // åŒæ­¥æ›´æ–°æœ¬åœ°ç¼“å­˜
                localStorage.setItem('personalBlogLogs', JSON.stringify(logs));
                return true;
            } catch (err) {
                console.error('ä¿å­˜åˆ°Gistå¤±è´¥:', err);
                // é™çº§ä¿å­˜åˆ°æœ¬åœ°
                localStorage.setItem('personalBlogLogs', JSON.stringify(logs));
                alert(`åŒæ­¥åˆ°GitHubå¤±è´¥ï¼š${err.message}\næ—¥å¿—å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œè¯·æ£€æŸ¥é…ç½®åé‡æ–°å‘å¸ƒ`);
                return false;
            }
        }

        // ========== è¯­éŸ³è¾“å…¥åŠŸèƒ½ ==========
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;       
        let isRestarting = false;      
        let permissionGranted = false; 
        let tempTranscript = '';       
        let lastResultTime = 0;        

        // æ™ºèƒ½æ–­å¥
        function addPunctuationByPause(rawText, currentTime) {
            let processedText = rawText;
            const pauseDuration = currentTime - lastResultTime;
            
            if (lastResultTime === 0) {
                lastResultTime = currentTime;
                return processedText;
            }

            if (pauseDuration >= 500 && pauseDuration < 1500) {
                if (!/[ï¼Œã€‚ï¼Ÿï¼ï¼›ï¼š\n]$/.test(processedText)) {
                    processedText += 'ï¼Œ';
                }
            } else if (pauseDuration >= 1500) {
                if (!/[ï¼Œã€‚ï¼Ÿï¼ï¼›ï¼š\n]$/.test(processedText)) {
                    processedText += 'ã€‚';
                }
            }

            lastResultTime = currentTime;
            return processedText;
        }

        // æœ€ç»ˆæ–‡æœ¬å¤„ç†
        function finalizeTranscript(text) {
            if (!text) return '';
            
            let finalText = text.replace(/ï¼Œ+/g, 'ï¼Œ')
                               .replace(/ã€‚+/g, 'ã€‚')
                               .replace(/ï¼Œã€‚/g, 'ã€‚')
                               .replace(/\n+/g, '\n');

            if (finalText && !/[ã€‚ï¼Ÿï¼ï¼›ï¼š\n]$/.test(finalText)) {
                finalText += 'ã€‚';
            }

            return finalText;
        }

        // ç¯å¢ƒæ£€æµ‹
        function checkEnv() {
            const isFileProtocol = window.location.protocol === 'file:';
            if (isFileProtocol) {
                envTip.innerHTML = 'ğŸ“¢ è¯­éŸ³è¾“å…¥æç¤ºï¼š<br>1. ç”µè„‘ç«¯æœ¬åœ°æ–‡ä»¶å¯èƒ½é™åˆ¶éº¦å…‹é£ï¼Œå»ºè®®ç”¨httpæœåŠ¡å™¨æ‰“å¼€ï¼›<br>2. æ— éœ€è¯´æ ‡ç‚¹ï¼åœé¡¿çŸ­åŠ é€—å·ï¼Œåœé¡¿é•¿åŠ å¥å·ï¼›<br>3. è¯´å®Œæ‰‹åŠ¨ç‚¹å‡»åœæ­¢ï¼Œæ ‡ç‚¹æ›´ç²¾å‡†';
                envTip.style.background = '#fff3cd';
                envTip.style.color = '#856404';
            }
        }

        // åˆå§‹åŒ–è¯­éŸ³è¯†åˆ«
        function initVoiceRecognition() {
            if (recognition) return;

            if (!SpeechRecognition) {
                voiceStatus.className = 'error';
                voiceStatus.textContent = 'âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼ˆå»ºè®®ç”¨Chrome/Edgeï¼‰';
                voiceInputBtn.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;        
            recognition.interimResults = true;     
            recognition.maxAlternatives = 1;
            recognition.onerror = (event) => handleRecognitionError(event);
            recognition.onresult = (event) => handleRecognitionResult(event);
            recognition.onstart = handleRecognitionStart;
            recognition.onend = handleRecognitionEnd;

            if (recognition.hasOwnProperty('speechInputCompleteTimeout')) {
                recognition.speechInputCompleteTimeout = 30000;
            }
            if (recognition.hasOwnProperty('speechDetectionTimeout')) {
                recognition.speechDetectionTimeout = 30000;
            }
            if (recognition.hasOwnProperty('continuous')) {
                recognition.continuous = true;
            }
        }

        // è¯­éŸ³è¯†åˆ«å¼€å§‹
        function handleRecognitionStart() {
            permissionGranted = true;
            isRecording = true;
            isRestarting = false;
            tempTranscript = '';
            lastResultTime = 0;
            voiceInputBtn.classList.add('recording');
            voiceInputBtn.textContent = 'ğŸ™ï¸ æ­£åœ¨å½•éŸ³...';
            voiceStatus.className = '';
            voiceStatus.textContent = 'âœ… æ­£åœ¨å€¾å¬ï¼Œæ­£å¸¸è¯´è¯å³å¯ï¼ˆåœé¡¿è‡ªåŠ¨åŠ æ ‡ç‚¹ï¼‰';
        }

        // è¯­éŸ³è¯†åˆ«ç»“æœå¤„ç†
        function handleRecognitionResult(event) {
            const currentTime = new Date().getTime();
            let currentTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    currentTranscript += event.results[i][0].transcript.trim();
                }
            }

            if (currentTranscript && currentTranscript !== tempTranscript) {
                tempTranscript = addPunctuationByPause(currentTranscript, currentTime);
                voiceStatus.textContent = `âœ… æ­£åœ¨è¯†åˆ«ï¼š${tempTranscript}ï¼ˆæ— éœ€è¯´æ ‡ç‚¹ï¼‰`;
            }
        }

        // è¯­éŸ³è¯†åˆ«ç»“æŸ
        function handleRecognitionEnd() {
            if (isRecording && permissionGranted && !isRestarting) {
                isRestarting = true;
                setTimeout(() => {
                    try {
                        recognition.start();
                        isRestarting = false;
                        voiceStatus.textContent = 'âœ… ç»§ç»­å€¾å¬ä¸­ï¼Œæ­£å¸¸è¯´è¯å³å¯...';
                    } catch (err) {
                        isRestarting = false;
                        voiceStatus.className = 'error';
                        voiceStatus.textContent = `âŒ é‡å¯è¯†åˆ«å¤±è´¥ï¼š${err.message}`;
                    }
                }, 300);
                return;
            }

            if (!isRecording) {
                const finalText = finalizeTranscript(tempTranscript);
                if (finalText) {
                    const currentContent = logContent.value.trim();
                    logContent.value = currentContent + (currentContent ? ' ' : '') + finalText;
                    voiceStatus.textContent = `âœ… è¯†åˆ«å®Œæˆï¼š${finalText}`;
                } else {
                    voiceStatus.textContent = 'ğŸ”´ å½•éŸ³å·²åœæ­¢ï¼Œæœªè¯†åˆ«åˆ°å†…å®¹';
                }
                voiceInputBtn.classList.remove('recording');
                voiceInputBtn.textContent = 'ğŸ™ï¸ è¯­éŸ³è¾“å…¥';
                permissionGranted = false;
                tempTranscript = '';
                lastResultTime = 0;
            }
        }

        // è¯­éŸ³è¯†åˆ«é”™è¯¯å¤„ç†
        function handleRecognitionError(event) {
            const errorText = finalizeTranscript(tempTranscript);
            if (errorText) {
                logContent.value = logContent.value + errorText + ' ';
                voiceStatus.textContent = `âœ… è¯†åˆ«åˆ°éƒ¨åˆ†å†…å®¹ï¼š${errorText}ï¼ˆå› ${event.error}æš‚åœï¼‰`;
            }

            isRestarting = false;
            if (event.error === 'not-allowed') {
                isRecording = false;
                permissionGranted = false;
                voiceInputBtn.classList.remove('recording');
                voiceInputBtn.textContent = 'ğŸ™ï¸ è¯­éŸ³è¾“å…¥';
                voiceStatus.className = 'error';
                voiceStatus.textContent = window.location.protocol === 'file:' 
                    ? 'âŒ æœ¬åœ°æ–‡ä»¶æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼å»ºè®®ç”¨httpæœåŠ¡å™¨æ‰“å¼€'
                    : 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼è¯·åœ¨åœ°å€æ å·¦ä¾§ğŸ”’å›¾æ ‡ä¸­å¼€å¯';
            } else if (event.error === 'no-speech') {
                voiceStatus.textContent = 'âš ï¸ æš‚æ—¶æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·ç»§ç»­è¯´è¯ï¼ˆæŒç»­å€¾å¬ä¸­ï¼‰';
                if (isRecording && permissionGranted) {
                    setTimeout(() => recognition.start(), 300);
                }
            } else {
                voiceStatus.className = 'error';
                voiceStatus.textContent = `âŒ è¯†åˆ«å¼‚å¸¸ï¼š${event.error}ï¼ˆå·²ä¿å­˜éƒ¨åˆ†å†…å®¹ï¼‰`;
                if (isRecording && permissionGranted) {
                    setTimeout(() => recognition.start(), 500);
                }
            }
        }

        // è¯­éŸ³è¾“å…¥æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        voiceInputBtn.addEventListener('click', async () => {
            if (!recognition) {
                initVoiceRecognition();
                if (!recognition) return;
            }

            if (isRecording) {
                isRecording = false;
                recognition.stop();
                voiceStatus.textContent = 'ğŸ”„ æ­£åœ¨æ•´ç†è¯†åˆ«ç»“æœ...';
                return;
            }

            try {
                recognition.start();
                voiceStatus.textContent = 'ğŸ”„ æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...';
            } catch (err) {
                voiceStatus.className = 'error';
                voiceStatus.textContent = `âŒ å¯åŠ¨å½•éŸ³å¤±è´¥ï¼š${err.message}`;
            }
        });

        // ========== æ—¥å¿—æ¸²æŸ“å’Œç­›é€‰ ==========
        // æ¸²æŸ“æ—¥å¿—åˆ—è¡¨
        function renderLogs(logsToRender) {
            if (logsToRender.length === 0) {
                logsList.innerHTML = '<div class="no-result">æš‚æ— æ—¥å¿—å†…å®¹</div>';
                return;
            }

            logsList.innerHTML = logsToRender.map(log => `
                <div class="log-item">
                    <h3>${log.title}</h3>
                    <div class="log-tags">æ ‡ç­¾ï¼š${log.tags.length > 0 ? log.tags.join('ï¼Œ') : 'æ— '}</div>
                    <div class="log-content">${log.content}</div>
                    <div class="log-time">å‘å¸ƒæ—¶é—´ï¼š${log.time}</div>
                </div>
            `).join('');
        }

        // æ¸²æŸ“æ ‡ç­¾åˆ—è¡¨
        function renderTags() {
            const allTags = [...new Set(logs.flatMap(log => log.tags))];
            tagList.innerHTML = allTags.map(tag => `
                <span class="tag-item" data-tag="${tag}">${tag}</span>
            `).join('');

            // æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.tag-item').forEach(tag => {
                tag.addEventListener('click', () => {
                    document.querySelectorAll('.tag-item').forEach(t => t.classList.remove('active'));
                    tag.classList.add('active');
                    const selectedTag = tag.dataset.tag;
                    const filteredLogs = logs.filter(log => log.tags.includes(selectedTag));
                    renderLogs(filteredLogs);
                });
            });
        }

        // æ—¥æœŸç­›é€‰
        dateSearchBtn.addEventListener('click', () => {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate && !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸæˆ–ç»“æŸæ—¥æœŸ');
                return;
            }

            let filteredLogs = logs;
            if (startDate) {
                filteredLogs = filteredLogs.filter(log => log.date >= startDate);
            }
            if (endDate) {
                filteredLogs = filteredLogs.filter(log => log.date <= endDate);
            }

            renderLogs(filteredLogs);
        });

        // å…³é”®è¯æœç´¢
        searchBtn.addEventListener('click', () => {
            const keyword = searchInput.value.trim().toLowerCase();
            if (!keyword) {
                renderLogs(logs);
                return;
            }

            const filteredLogs = logs.filter(log => 
                log.title.toLowerCase().includes(keyword) || 
                log.content.toLowerCase().includes(keyword) ||
                log.tags.some(tag => tag.toLowerCase().includes(keyword))
            );
            renderLogs(filteredLogs);
        });

        // å‘å¸ƒæ—¥å¿—
        publishBtn.addEventListener('click', async () => {
            const title = logTitle.value.trim();
            const content = logContent.value.trim();
            const tagsStr = logTags.value.trim();
            
            if (!title || !content) {
                alert('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            const tags = tagsStr ? tagsStr.split(',').map(tag => tag.trim()).filter(tag => tag) : [];
            const now = new Date();
            const newLog = {
                title: title,
                content: content,
                tags: tags,
                time: now.toLocaleString(),
                date: now.toISOString().split('T')[0]
            };

            // æ·»åŠ æ–°æ—¥å¿—
            logs.unshift(newLog);
            
            // ä¿å­˜åˆ°Gistï¼ˆè‡ªåŠ¨é™çº§åˆ°æœ¬åœ°ï¼‰
            const saveSuccess = await saveLogsToGist(logs);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            logTitle.value = '';
            logContent.value = '';
            logTags.value = '';

            // é‡æ–°æ¸²æŸ“
            renderLogs(logs);
            renderTags();
            
            if (saveSuccess) {
                alert('æ—¥å¿—å‘å¸ƒæˆåŠŸï¼å·²åŒæ­¥åˆ°GitHub Gistï¼Œè·¨è®¾å¤‡éƒ½èƒ½çœ‹åˆ°');
            }
        });

        // ========== é¡µé¢åˆå§‹åŒ– ==========
        window.addEventListener('load', async () => {
            checkEnv();
            initVoiceRecognition();
            // ä»GiståŠ è½½æ—¥å¿—
            logs = await fetchLogsFromGist();
            // åˆå§‹æ¸²æŸ“
            renderLogs(logs);
            renderTags();
        });
    </script>
</body>
</html>
