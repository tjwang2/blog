<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人博客（编辑/删除+Gist同步）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Microsoft YaHei"; }
        .container { max-width: 800px; margin: 20px auto; padding: 0 20px; }
        .form-area { margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; }
        input, textarea { width: 100%; margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { min-height: 100px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .publish-btn { background: #007bff; color: white; }
        .edit-btn { background: #17a2b8; color: white; }
        .delete-btn { background: #dc3545; color: white; }
        .confirm-btn { background: #28a745; color: white; display: none; }
        .cancel-btn { background: #6c757d; color: white; display: none; }
        .log-item { margin: 15px 0; padding: 15px; border: 1px solid #eee; border-radius: 8px; }
        .log-actions { margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>我的个人博客</h1>
        
        <!-- 发布/编辑表单 -->
        <div class="form-area">
            <input type="text" id="title" placeholder="日志标题">
            <textarea id="content" placeholder="日志内容"></textarea>
            <input type="text" id="tags" placeholder="标签（逗号分隔）">
            <button class="btn publish-btn" id="publish">发布</button>
            <button class="btn confirm-btn" id="confirm-edit">确认修改</button>
            <button class="btn cancel-btn" id="cancel-edit">取消编辑</button>
        </div>

        <!-- 日志列表 -->
        <div id="log-list"></div>
    </div>

    <script>
        // ========== 只改这两个！！！ ==========
        const GIST_ID = 'da19e701ffe11b272fdf90f3d7051d1a'; // 替换成正确的Gist ID（纯字符串，无空格）
        const GITHUB_TOKEN = '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'; // 替换成ghp_开头的Token（纯字符串）
        // ========== 配置结束 ==========

        let logs = [];
        let editingIndex = -1; // 编辑索引

        // 初始化：加载Gist数据
        window.onload = async () => {
            logs = await loadFromGist() || [];
            renderLogs();
        };

        // 【修正核心】从Gist加载日志（正确的Header传Token方式）
        async function loadFromGist() {
            try {
                const response = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`, // 正确的Token传递方式
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`加载失败：${response.status} ${response.statusText}`);
                }

                const gistData = await response.json();
                // 检查文件是否存在
                if (!gistData.files['blog-logs.json']) {
                    throw new Error('Gist中未找到blog-logs.json文件');
                }

                // 解析日志内容
                const logContent = gistData.files['blog-logs.json'].content || '[]';
                return JSON.parse(logContent);
            } catch (error) {
                console.log('加载Gist失败，使用本地数据：', error.message);
                // 降级到本地存储
                return JSON.parse(localStorage.getItem('blog-logs') || '[]');
            }
        }

        // 【修正核心】保存到Gist（正确的Header传Token方式）
        async function saveToGist() {
            try {
                // 1. 先获取Gist的最新信息（获取文件SHA，避免冲突）
                const getResponse = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!getResponse.ok) {
                    throw new Error(`获取Gist信息失败：${getResponse.status}`);
                }
                const gistData = await getResponse.json();

                // 2. 构造更新请求（正确的Header+请求体）
                const updateResponse = await fetch(`https://api.github.com/gists/${GIST_ID}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`, // 核心：Token在Header里
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'blog-logs.json': {
                                content: JSON.stringify(logs, null, 2), // 格式化JSON
                                sha: gistData.files['blog-logs.json']?.sha // 必须传SHA避免冲突
                            }
                        }
                    })
                });

                if (!updateResponse.ok) {
                    const errorDetail = await updateResponse.text();
                    throw new Error(`同步失败：${updateResponse.status} - ${errorDetail}`);
                }

                // 同步成功：更新本地存储+提示
                localStorage.setItem('blog-logs', JSON.stringify(logs));
                alert('✅ 日志同步到GitHub Gist成功！');
                return true;
            } catch (error) {
                console.error('同步Gist失败：', error);
                // 降级：只保存到本地
                localStorage.setItem('blog-logs', JSON.stringify(logs));
                alert(`⚠️ 仅保存到本地，同步失败：${error.message}`);
                return false;
            }
        }

        // 渲染日志列表
        function renderLogs() {
            const list = document.getElementById('log-list');
            if (logs.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#999; padding:20px;">暂无日志，发布你的第一篇日志吧～</div>';
                return;
            }

            list.innerHTML = logs.map((log, index) => `
                <div class="log-item">
                    <h3>${log.title}</h3>
                    <p style="margin:10px 0; color:#555;">${log.content}</p>
                    <p style="color:#888; font-size:0.9rem;">标签：${log.tags.join(', ') || '无'}</p>
                    <p style="color:#999; font-size:0.8rem;">发布时间：${log.time}</p>
                    <div class="log-actions">
                        <button class="btn edit-btn" onclick="editLog(${index})">编辑</button>
                        <button class="btn delete-btn" onclick="deleteLog(${index})">删除</button>
                    </div>
                </div>
            `).join('');
        }

        // 发布新日志
        document.getElementById('publish').addEventListener('click', async () => {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
            
            if (!title || !content) {
                alert('标题和内容不能为空！');
                return;
            }

            // 构造新日志
            const newLog = {
                title,
                content,
                tags,
                time: new Date().toLocaleString(),
                date: new Date().toISOString().split('T')[0]
            };

            // 添加到日志列表
            logs.unshift(newLog);
            // 保存到Gist（自动降级到本地）
            await saveToGist();
            // 重新渲染+清空表单
            renderLogs();
            clearForm();
        });

        // 编辑日志
        function editLog(index) {
            editingIndex = index;
            const log = logs[index];
            // 填充表单
            document.getElementById('title').value = log.title;
            document.getElementById('content').value = log.content;
            document.getElementById('tags').value = log.tags.join(',');
            // 切换按钮显示
            document.getElementById('publish').style.display = 'none';
            document.getElementById('confirm-edit').style.display = 'inline-block';
            document.getElementById('cancel-edit').style.display = 'inline-block';
            // 滚动到表单
            document.querySelector('.form-area').scrollIntoView({ behavior: 'smooth' });
        }

        // 确认编辑
        document.getElementById('confirm-edit').addEventListener('click', async () => {
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();
            const tags = document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t);
            
            if (!title || !content) {
                alert('标题和内容不能为空！');
                return;
            }

            // 更新日志（保留原时间）
            logs[editingIndex] = {
                ...logs[editingIndex],
                title,
                content,
                tags
            };

            // 保存到Gist
            await saveToGist();
            // 退出编辑模式+重新渲染
            cancelEdit();
            renderLogs();
        });

        // 取消编辑
        function cancelEdit() {
            editingIndex = -1;
            clearForm();
            // 恢复按钮显示
            document.getElementById('publish').style.display = 'inline-block';
            document.getElementById('confirm-edit').style.display = 'none';
            document.getElementById('cancel-edit').style.display = 'none';
        }

        // 删除日志
        async function deleteLog(index) {
            if (!confirm('确定要删除这篇日志吗？删除后无法恢复！')) {
                return;
            }
            // 删除日志
            logs.splice(index, 1);
            // 保存到Gist
            await saveToGist();
            // 重新渲染
            renderLogs();
        }

        // 清空表单
        function clearForm() {
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            document.getElementById('tags').value = '';
        }

        // 绑定取消编辑按钮
        document.getElementById('cancel-edit').addEventListener('click', cancelEdit);
    </script>
</body>
</html>
