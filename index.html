<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„ä¸ªäººåšå®¢</title>
    <style>
        /* åŸæœ‰æ ·å¼å®Œå…¨ä¿ç•™ï¼Œæ–°å¢ç¼–è¾‘/åˆ é™¤æŒ‰é’®æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", Arial, sans-serif;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .calendar-area {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .calendar-area h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .range-text {
            color: #666;
            font-size: 0.9rem;
        }

        #date-search-btn {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .tags-area {
            margin-bottom: 20px;
        }

        .tags-area h3 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .tag-item {
            display: inline-block;
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 20px;
            margin-right: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            color: #495057;
        }

        .tag-item.active {
            background: #007bff;
            color: white;
        }

        .search-area {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        #search-btn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        #search-btn:hover {
            background: #218838;
        }

        /* æ–°å¢ï¼šå¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .export-area {
            margin-bottom: 20px;
            text-align: right;
        }

        #export-btn {
            padding: 10px 20px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        #export-btn:hover {
            background: #138496;
        }

        /* æ–°å¢ï¼šå¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª— */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .export-modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .export-modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .export-format-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .export-format-item input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
        }

        .export-modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .export-confirm-btn {
            padding: 8px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .export-cancel-btn {
            padding: 8px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .form-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"], textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
            resize: vertical;
        }

        textarea {
            min-height: 150px;
            line-height: 1.5;
        }

        #publish-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        #publish-btn:hover {
            background: #0056b3;
        }

        .voice-btn {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
        }

        .voice-btn:hover {
            background: #eee;
        }

        .voice-btn.recording {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fecdd3;
        }

        #voice-status {
            font-size: 0.85rem;
            margin-left: 10px;
            color: #999;
            vertical-align: middle;
        }

        .voice-status.error {
            color: #dc2626;
            font-weight: 500;
        }

        .voice-status.tip {
            color: #007bff;
            font-weight: 500;
        }

        .logs-area h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .log-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            position: relative; /* æ–°å¢ï¼šä¸ºç¼–è¾‘/åˆ é™¤æŒ‰é’®å®šä½ */
        }

        .log-item h3 {
            color: #007bff;
            margin-bottom: 8px;
        }

        .log-item .log-tags {
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .log-item .log-content {
            color: #555;
            line-height: 1.8;
            margin: 10px 0;
            white-space: pre-line;
        }

        .log-item .log-time {
            color: #999;
            font-size: 0.85rem;
            text-align: right;
            margin-top: 10px;
        }

        /* æ–°å¢ï¼šç¼–è¾‘/åˆ é™¤æŒ‰é’®æ ·å¼ */
        .log-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }

        .edit-btn {
            padding: 4px 8px;
            background: #ffc107;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .edit-btn:hover {
            background: #ffca2c;
        }

        .delete-btn {
            padding: 4px 8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-btn:hover {
            background: #e55361;
        }

        /* æ–°å¢ï¼šç¼–è¾‘çŠ¶æ€æ ·å¼ */
        .form-area .edit-tip {
            color: #ffc107;
            font-weight: 500;
            margin-bottom: 15px;
            padding: 8px;
            background: #fff8e1;
            border-radius: 4px;
        }

        #cancel-edit-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 10px;
        }

        #cancel-edit-btn:hover {
            background: #5a6268;
        }

        .no-result {
            text-align: center;
            color: #999;
            padding: 10px 20px;
            font-size: 1rem;
        }

        .env-tip {
            background: #e7f3ff;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #0c5460;
            line-height: 1.5;
        }
    </style>
    <!-- å¼•å…¥å¯¼å‡ºæ‰€éœ€ç¬¬ä¸‰æ–¹åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epub-gen@0.1.19/dist/epub-gen.browser.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>æˆ‘çš„ä¸ªäººåšå®¢</h1>

        <div class="calendar-area">
            <h3>æŒ‰æ—¥æœŸ/æ—¶é—´æ®µæŸ¥æ‰¾æ—¥å¿—</h3>
            <div class="date-range">
                <input type="date" id="start-date" class="date-input" placeholder="å¼€å§‹æ—¥æœŸ">
                <span class="range-text">è‡³</span>
                <input type="date" id="end-date" class="date-input" placeholder="ç»“æŸæ—¥æœŸ">
                <button id="date-search-btn">æŸ¥æ‰¾</button>
            </div>
        </div>

        <div class="tags-area">
            <h3>æŒ‰æ ‡ç­¾ç­›é€‰æ—¥å¿—</h3>
            <div id="tag-list" class="tag-container">
            </div>
        </div>

        <div class="search-area">
            <input type="text" id="search-input" placeholder="è¾“å…¥å…³é”®è¯æ£€ç´¢æ—¥å¿—ï¼ˆæ ‡é¢˜/æ­£æ–‡ï¼‰...">
            <button id="search-btn">å…¨æ–‡æ£€ç´¢</button>
        </div>

        <!-- æ–°å¢ï¼šå¯¼å‡ºæŒ‰é’®åŒºåŸŸ -->
        <div class="export-area">
            <button id="export-btn">ğŸ“¤ ä¸€é”®å¯¼å‡º</button>
        </div>

        <!-- æ–°å¢ï¼šå¯¼å‡ºæ ¼å¼é€‰æ‹©å¼¹çª— -->
        <div class="export-modal" id="export-modal">
            <div class="export-modal-content">
                <h3>é€‰æ‹©å¯¼å‡ºæ ¼å¼</h3>
                <div class="export-format-item">
                    <input type="radio" name="export-format" id="format-txt" value="txt" checked>
                    <label for="format-txt">TXT çº¯æ–‡æœ¬</label>
                </div>
                <div class="export-format-item">
                    <input type="radio" name="export-format" id="format-pdf" value="pdf">
                    <label for="format-pdf">PDF æ–‡æ¡£ï¼ˆç›®å½•ä¸å¯ç‚¹å‡»ï¼‰</label>
                </div>
                <div class="export-format-item">
                    <input type="radio" name="export-format" id="format-epub" value="epub">
                    <label for="format-epub">EPUB ç”µå­ä¹¦ï¼ˆç›®å½•å¯ç‚¹å‡»ï¼‰</label>
                </div>
                <div class="export-modal-btns">
                    <button class="export-confirm-btn" id="export-confirm-btn">ç¡®è®¤å¯¼å‡º</button>
                    <button class="export-cancel-btn" id="export-cancel-btn">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <div class="form-area">
            <h2>å‘å¸ƒæ–°æ—¥å¿—</h2>
            <!-- æ–°å¢ï¼šç¼–è¾‘æç¤º -->
            <div class="edit-tip" id="edit-tip" style="display: none;">ğŸ“ æ­£åœ¨ç¼–è¾‘æ—¥å¿—ï¼Œè¯·ä¿®æ”¹åç‚¹å‡»ã€Œæ›´æ–°æ—¥å¿—ã€</div>
            <div class="env-tip" id="env-tip">ğŸ“¢ è¯­éŸ³è¾“å…¥æç¤ºï¼š<br>1. ç”µè„‘ç«¯å»ºè®®ç”¨Chrome/Edgeæµè§ˆå™¨ï¼›<br>2. æ— éœ€è¯´æ ‡ç‚¹ï¼åœé¡¿çŸ­åŠ é€—å·ï¼Œåœé¡¿é•¿åŠ å¥å·ï¼›<br>3. è¯´å®Œæ‰‹åŠ¨ç‚¹å‡»åœæ­¢ï¼Œæ ‡ç‚¹æ›´ç²¾å‡†</div>
            <div class="form-group">
                <label for="log-title">æ—¥å¿—æ ‡é¢˜</label>
                <input type="text" id="log-title" placeholder="è¾“å…¥æ—¥å¿—æ ‡é¢˜...">
            </div>
            <div class="form-group">
                <label for="log-content">æ—¥å¿—å†…å®¹</label>
                <textarea id="log-content" placeholder="è¾“å…¥æ—¥å¿—å†…å®¹...ï¼ˆæ•²å›è½¦å¯åˆ†æ®µï¼‰"></textarea>
                <button type="button" id="voice-input-btn" class="voice-btn">
                    ğŸ™ï¸ è¯­éŸ³è¾“å…¥
                </button>
                <span id="voice-status"></span>
            </div>
            <div class="form-group">
                <label for="log-tags">æ—¥å¿—æ ‡ç­¾ï¼ˆå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="log-tags" placeholder="ä¾‹å¦‚ï¼šç”Ÿæ´»,å­¦ä¹ ,å·¥ä½œ...">
            </div>
            <button id="publish-btn">å‘å¸ƒæ—¥å¿—</button>
            <!-- æ–°å¢ï¼šå–æ¶ˆç¼–è¾‘æŒ‰é’® -->
            <button id="cancel-edit-btn" style="display: none;">å–æ¶ˆç¼–è¾‘</button>
        </div>

        <div class="logs-area">
            <h2>æˆ‘çš„æ—¥å¿—åˆ—è¡¨</h2>
            <div id="logs-list"></div>
        </div>
    </div>

    <script>
        let logs = JSON.parse(localStorage.getItem('personalBlogLogs')) || [];
        logs = logs.map(log => ({ 
            tags: [], 
            time: log.time || new Date().toLocaleString(),
            date: log.date || new Date(log.time || new Date()).toISOString().split('T')[0],
            ...log 
        }));

        const publishBtn = document.getElementById('publish-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn'); // æ–°å¢
        const editTip = document.getElementById('edit-tip'); // æ–°å¢
        const logTitle = document.getElementById('log-title');
        const logContent = document.getElementById('log-content');
        const logTags = document.getElementById('log-tags');
        const logsList = document.getElementById('logs-list');
        const tagList = document.getElementById('tag-list');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const dateSearchBtn = document.getElementById('date-search-btn');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const voiceStatus = document.getElementById('voice-status');
        const envTip = document.getElementById('env-tip');

        // æ–°å¢ï¼šå¯¼å‡ºç›¸å…³DOM
        const exportBtn = document.getElementById('export-btn');
        const exportModal = document.getElementById('export-modal');
        const exportConfirmBtn = document.getElementById('export-confirm-btn');
        const exportCancelBtn = document.getElementById('export-cancel-btn');

        // æ–°å¢ï¼šå½“å‰æ¸²æŸ“çš„æ—¥å¿—ï¼ˆç”¨äºå¯¼å‡ºï¼‰
        let currentRenderedLogs = logs;

        // æ–°å¢ï¼šå½“å‰ç¼–è¾‘çš„æ—¥å¿—ç´¢å¼•
        let editingIndex = -1;

        // ========== æ™ºèƒ½è¯­éŸ³è¾“å…¥ï¼ˆåŸæœ‰ä»£ç ï¼Œæ— ä¿®æ”¹ï¼‰ ==========
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isRecording = false;       
        let isRestarting = false;      
        let permissionGranted = false; 
        let tempTranscript = '';       
        let lastResultTime = 0;        

        function addPunctuationByPause(rawText, currentTime) {
            let processedText = rawText;
            const pauseDuration = currentTime - lastResultTime;
            
            if (lastResultTime === 0) {
                lastResultTime = currentTime;
                return processedText;
            }

            if (pauseDuration >= 500 && pauseDuration < 1500) {
                if (!/[ï¼Œã€‚ï¼Ÿï¼ï¼›ï¼š\n]$/.test(processedText)) {
                    processedText += 'ï¼Œ';
                }
            } else if (pauseDuration >= 1500) {
                if (!/[ï¼Œã€‚ï¼Ÿï¼ï¼›ï¼š\n]$/.test(processedText)) {
                    processedText += 'ã€‚';
                }
            }

            lastResultTime = currentTime;
            return processedText;
        }

        function finalizeTranscript(text) {
            if (!text) return '';
            
            let finalText = text.replace(/ï¼Œ+/g, 'ï¼Œ')
                               .replace(/ã€‚+/g, 'ã€‚')
                               .replace(/ï¼Œã€‚/g, 'ã€‚')
                               .replace(/\n+/g, '\n');

            if (finalText && !/[ã€‚ï¼Ÿï¼ï¼›ï¼š\n]$/.test(finalText)) {
                finalText += 'ã€‚';
            }

            return finalText;
        }

        function checkEnv() {
            const isFileProtocol = window.location.protocol === 'file:';
            if (isFileProtocol) {
                envTip.innerHTML = 'ğŸ“¢ è¯­éŸ³è¾“å…¥æç¤ºï¼š<br>1. ç”µè„‘ç«¯å»ºè®®ç”¨Chrome/Edgeæµè§ˆå™¨ï¼›<br>2. æ— éœ€è¯´æ ‡ç‚¹ï¼åœé¡¿çŸ­åŠ é€—å·ï¼Œåœé¡¿é•¿åŠ å¥å·ï¼›<br>3. è¯´å®Œæ‰‹åŠ¨ç‚¹å‡»åœæ­¢ï¼Œæ ‡ç‚¹æ›´ç²¾å‡†';
                envTip.style.background = '#fff3cd';
                envTip.style.color = '#856404';
            }
        }

        function initVoiceRecognition() {
            if (recognition) return;

            if (!SpeechRecognition) {
                voiceStatus.className = 'error';
                voiceStatus.textContent = 'âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼ˆå»ºè®®ç”¨Chrome/Edgeï¼‰';
                voiceInputBtn.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.lang = 'zh-CN';
            recognition.continuous = true;        
            recognition.interimResults = true;     
            recognition.maxAlternatives = 1;
            recognition.onerror = (event) => handleRecognitionError(event);
            recognition.onresult = (event) => handleRecognitionResult(event);
            recognition.onstart = handleRecognitionStart;
            recognition.onend = handleRecognitionEnd;

            if (recognition.hasOwnProperty('speechInputCompleteTimeout')) {
                recognition.speechInputCompleteTimeout = 30000;
            }
            if (recognition.hasOwnProperty('speechDetectionTimeout')) {
                recognition.speechDetectionTimeout = 30000;
            }
            if (recognition.hasOwnProperty('continuous')) {
                recognition.continuous = true;
            }
        }

        function handleRecognitionStart() {
            permissionGranted = true;
            isRecording = true;
            isRestarting = false;
            tempTranscript = '';
            lastResultTime = 0;
            voiceInputBtn.classList.add('recording');
            voiceInputBtn.textContent = 'ğŸ™ï¸ æ­£åœ¨å½•éŸ³...';
            voiceStatus.className = '';
            voiceStatus.textContent = 'âœ… æ­£åœ¨å€¾å¬ï¼Œæ­£å¸¸è¯´è¯å³å¯ï¼ˆåœé¡¿è‡ªåŠ¨åŠ æ ‡ç‚¹ï¼‰';
        }

        function handleRecognitionResult(event) {
            const currentTime = new Date().getTime();
            let currentTranscript = '';

            for (let i = event.resultIndex; i < event.results.length; i++) {
                if (event.results[i].isFinal) {
                    currentTranscript += event.results[i][0].transcript.trim();
                }
            }

            if (currentTranscript && currentTranscript !== tempTranscript) {
                tempTranscript = addPunctuationByPause(currentTranscript, currentTime);
                voiceStatus.textContent = `âœ… æ­£åœ¨è¯†åˆ«ï¼š${tempTranscript}ï¼ˆæ— éœ€è¯´æ ‡ç‚¹ï¼‰`;
            }
        }

        function handleRecognitionEnd() {
            if (isRecording && permissionGranted && !isRestarting) {
                isRestarting = true;
                setTimeout(() => {
                    try {
                        recognition.start();
                        isRestarting = false;
                        voiceStatus.textContent = 'âœ… ç»§ç»­å€¾å¬ä¸­ï¼Œæ­£å¸¸è¯´è¯å³å¯...';
                    } catch (err) {
                        isRestarting = false;
                        voiceStatus.className = 'error';
                        voiceStatus.textContent = `âŒ é‡å¯è¯†åˆ«å¤±è´¥ï¼š${err.message}`;
                    }
                }, 300);
                return;
            }

            if (!isRecording) {
                const finalText = finalizeTranscript(tempTranscript);
                if (finalText) {
                    const currentContent = logContent.value.trim();
                    logContent.value = currentContent + (currentContent ? ' ' : '') + finalText;
                    voiceStatus.textContent = `âœ… è¯†åˆ«å®Œæˆï¼š${finalText}`;
                } else {
                    voiceStatus.textContent = 'ğŸ”´ å½•éŸ³å·²åœæ­¢ï¼Œæœªè¯†åˆ«åˆ°å†…å®¹';
                }
                voiceInputBtn.classList.remove('recording');
                voiceInputBtn.textContent = 'ğŸ™ï¸ è¯­éŸ³è¾“å…¥';
                permissionGranted = false;
                tempTranscript = '';
                lastResultTime = 0;
            }
        }

        function handleRecognitionError(event) {
            const errorText = finalizeTranscript(tempTranscript);
            if (errorText) {
                logContent.value = logContent.value + errorText + ' ';
                voiceStatus.textContent = `âœ… è¯†åˆ«åˆ°éƒ¨åˆ†å†…å®¹ï¼š${errorText}ï¼ˆå› ${event.error}æš‚åœï¼‰`;
            }

            isRestarting = false;
            if (event.error === 'not-allowed') {
                isRecording = false;
                permissionGranted = false;
                voiceInputBtn.classList.remove('recording');
                voiceInputBtn.textContent = 'ğŸ™ï¸ è¯­éŸ³è¾“å…¥';
                voiceStatus.className = 'error';
                voiceStatus.textContent = window.location.protocol === 'file:' 
                    ? 'âŒ æœ¬åœ°æ–‡ä»¶æ— æ³•è·å–éº¦å…‹é£æƒé™ï¼å»ºè®®ç”¨httpæœåŠ¡å™¨æ‰“å¼€'
                    : 'âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼è¯·åœ¨åœ°å€æ å·¦ä¾§ğŸ”’å›¾æ ‡ä¸­å¼€å¯';
            } else if (event.error === 'no-speech') {
                voiceStatus.textContent = 'âš ï¸ æš‚æ—¶æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·ç»§ç»­è¯´è¯ï¼ˆæŒç»­å€¾å¬ä¸­ï¼‰';
                if (isRecording && permissionGranted) {
                    setTimeout(() => recognition.start(), 300);
                }
            } else {
                voiceStatus.className = 'error';
                voiceStatus.textContent = `âŒ è¯†åˆ«å¼‚å¸¸ï¼š${event.error}ï¼ˆå·²ä¿å­˜éƒ¨åˆ†å†…å®¹ï¼‰`;
                if (isRecording && permissionGranted) {
                    setTimeout(() => recognition.start(), 500);
                }
            }
        }

        voiceInputBtn.addEventListener('click', async () => {
            if (!recognition) {
                initVoiceRecognition();
                if (!recognition) return;
            }

            if (isRecording) {
                isRecording = false;
                recognition.stop();
                voiceStatus.textContent = 'ğŸ”„ æ­£åœ¨æ•´ç†è¯†åˆ«ç»“æœ...';
                return;
            }

            voiceStatus.className = '';
            voiceStatus.textContent = 'ğŸ”„ æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...';
            try {
                permissionGranted = false;
                tempTranscript = '';
                lastResultTime = 0;
                isRestarting = false;
                await recognition.start();
            } catch (err) {
                voiceStatus.className = 'error';
                if (err.message.includes('not-allowed')) {
                    voiceStatus.textContent = 'âŒ æƒé™è¯·æ±‚å¤±è´¥ï¼è¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¼€å¯éº¦å…‹é£æƒé™';
                } else {
                    voiceStatus.textContent = `âŒ å¯åŠ¨å½•éŸ³å¤±è´¥ï¼š${err.message}`;
                }
                isRecording = false;
            }
        });

        // ========== åŸæœ‰åŠŸèƒ½ä¼˜åŒ–ï¼ˆæ–°å¢ç¼–è¾‘/åˆ é™¤é€»è¾‘ï¼‰ ==========
        // æ–°å¢ï¼šç¼–è¾‘æ—¥å¿—å‡½æ•°
        function editLog(index) {
            editingIndex = index;
            const log = logs[index];
            // å¡«å……è¡¨å•
            logTitle.value = log.title;
            logContent.value = log.content;
            logTags.value = log.tags.join(',');
            // åˆ‡æ¢æŒ‰é’®çŠ¶æ€
            publishBtn.textContent = 'æ›´æ–°æ—¥å¿—';
            cancelEditBtn.style.display = 'inline-block';
            editTip.style.display = 'block';
            // æ»šåŠ¨åˆ°è¡¨å•åŒºåŸŸ
            document.querySelector('.form-area').scrollIntoView({ behavior: 'smooth' });
        }

        // æ–°å¢ï¼šåˆ é™¤æ—¥å¿—å‡½æ•°
        function deleteLog(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥å¿—å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼')) {
                logs.splice(index, 1);
                localStorage.setItem('personalBlogLogs', JSON.stringify(logs));
                renderLogs(logs);
                renderTags();
                alert('æ—¥å¿—å·²æˆåŠŸåˆ é™¤ï¼');
            }
        }

        // æ–°å¢ï¼šå–æ¶ˆç¼–è¾‘å‡½æ•°
        function cancelEdit() {
            editingIndex = -1;
            // æ¸…ç©ºè¡¨å•
            logTitle.value = '';
            logContent.value = '';
            logTags.value = '';
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            publishBtn.textContent = 'å‘å¸ƒæ—¥å¿—';
            cancelEditBtn.style.display = 'none';
            editTip.style.display = 'none';
            voiceStatus.textContent = '';
        }

        // ä¼˜åŒ–å‘å¸ƒå‡½æ•°ï¼šæ”¯æŒç¼–è¾‘æ›´æ–°
        function publishLog() {
            const title = logTitle.value.trim();
            const content = logContent.value.trim();
            const tagsStr = logTags.value.trim();
            
            if (!title || !content) {
                alert('æ ‡é¢˜å’Œå†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            const tags = tagsStr ? tagsStr.split(',').map(tag => tag.trim()) : [];
            
            // ç¼–è¾‘æ¨¡å¼ï¼šæ›´æ–°ç°æœ‰æ—¥å¿—
            if (editingIndex >= 0) {
                logs[editingIndex] = {
                    ...logs[editingIndex],
                    title: title,
                    content: content,
                    tags: tags
                };
                alert('æ—¥å¿—å·²æˆåŠŸæ›´æ–°ï¼');
                cancelEdit(); // æ›´æ–°åå–æ¶ˆç¼–è¾‘çŠ¶æ€
            } 
            // å‘å¸ƒæ¨¡å¼ï¼šæ–°å¢æ—¥å¿—
            else {
                const now = new Date();
                const newLog = {
                    title: title,
                    content: content,
                    tags: tags,
                    time: now.toLocaleString(),
                    date: now.toISOString().split('T')[0]
                };
                logs.unshift(newLog);
                alert('æ—¥å¿—å‘å¸ƒæˆåŠŸï¼');
                // æ¸…ç©ºè¡¨å•
                logTitle.value = '';
                logContent.value = '';
                logTags.value = '';
            }

            localStorage.setItem('personalBlogLogs', JSON.stringify(logs));
            renderLogs(logs);
            renderTags();
        }

        function filterLogsByDate() {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            if (!startDate && !endDate) {
                renderLogs(logs);
                return;
            }

            const filteredLogs = logs.filter(log => {
                const logDate = log.date;
                if (startDate && !endDate) {
                    return logDate === startDate;
                } else if (!startDate && endDate) {
                    return logDate === endDate;
                } else {
                    return logDate >= startDate && logDate <= endDate;
                }
            });

            renderLogs(filteredLogs);
        }

        function renderTags() {
            const allTags = [...new Set(logs.flatMap(log => log.tags))];
            tagList.innerHTML = '';
            allTags.forEach(tag => {
                const tagItem = document.createElement('div');
                tagItem.className = 'tag-item';
                tagItem.textContent = tag;
                tagItem.addEventListener('click', () => {
                    document.querySelectorAll('.tag-item').forEach(item => item.classList.remove('active'));
                    tagItem.classList.add('active');
                    const filteredLogs = logs.filter(log => log.tags.includes(tag));
                    renderLogs(filteredLogs);
                });
                tagList.appendChild(tagItem);
            });
        }

        function searchLogs() {
            const keyword = searchInput.value.trim().toLowerCase();
            if (!keyword) {
                renderLogs(logs);
                return;
            }
            const filteredLogs = logs.filter(log => {
                const titleMatch = log.title.toLowerCase().includes(keyword);
                const contentMatch = log.content.toLowerCase().includes(keyword);
                return titleMatch || contentMatch;
            });
            renderLogs(filteredLogs);
        }

        // ä¼˜åŒ–æ¸²æŸ“å‡½æ•°ï¼šæ·»åŠ ç¼–è¾‘/åˆ é™¤æŒ‰é’® + è®°å½•å½“å‰æ¸²æŸ“çš„æ—¥å¿—
        function renderLogs(logsToRender) {
            // æ›´æ–°å½“å‰æ¸²æŸ“çš„æ—¥å¿—ï¼ˆç”¨äºå¯¼å‡ºï¼‰
            currentRenderedLogs = logsToRender;
            
            if (logsToRender.length === 0) {
                logsList.innerHTML = '<div class="no-result">æš‚æ— æ—¥å¿—æ•°æ®</div>';
                return;
            }

            let logsHtml = '';
            logsToRender.forEach((log, index) => {
                // æ‰¾åˆ°åŸå§‹æ•°ç»„ä¸­çš„ç´¢å¼•ï¼ˆç”¨äºç¼–è¾‘/åˆ é™¤ï¼‰
                const originalIndex = logs.findIndex(item => 
                    item.title === log.title && 
                    item.time === log.time && 
                    item.content === log.content
                );
                logsHtml += `
                    <div class="log-item">
                        <div class="log-actions">
                            <button class="edit-btn" onclick="editLog(${originalIndex})">ç¼–è¾‘</button>
                            <button class="delete-btn" onclick="deleteLog(${originalIndex})">åˆ é™¤</button>
                        </div>
                        <h3>${log.title}</h3>
                        <div class="log-tags">æ ‡ç­¾ï¼š${log.tags.join('ã€') || 'æ— '}</div>
                        <div class="log-content">${log.content}</div>
                        <div class="log-time">å‘å¸ƒæ—¶é—´ï¼š${log.time}</div>
                    </div>
                `;
            });
            logsList.innerHTML = logsHtml;
        }

        // ========== æ–°å¢ï¼šå¯¼å‡ºåŠŸèƒ½æ ¸å¿ƒé€»è¾‘ ==========
        // æ‰“å¼€å¯¼å‡ºå¼¹çª—
        exportBtn.addEventListener('click', () => {
            if (currentRenderedLogs.length === 0) {
                alert('æš‚æ— å¯å¯¼å‡ºçš„æ—¥å¿—æ•°æ®ï¼');
                return;
            }
            exportModal.style.display = 'flex';
        });

        // å…³é—­å¯¼å‡ºå¼¹çª—
        exportCancelBtn.addEventListener('click', () => {
            exportModal.style.display = 'none';
        });

        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
        exportModal.addEventListener('click', (e) => {
            if (e.target === exportModal) {
                exportModal.style.display = 'none';
            }
        });

        // ç¡®è®¤å¯¼å‡º
        exportConfirmBtn.addEventListener('click', () => {
            const selectedFormat = document.querySelector('input[name="export-format"]:checked').value;
            exportModal.style.display = 'none';
            
            switch (selectedFormat) {
                case 'txt':
                    exportAsTXT();
                    break;
                case 'pdf':
                    exportAsPDF();
                    break;
                case 'epub':
                    exportAsEPUB();
                    break;
            }
        });

        // å¯¼å‡ºä¸ºTXT
        function exportAsTXT() {
            // æ„å»ºå†…å®¹ï¼šå…ˆç›®å½•ï¼Œåæ­£æ–‡
            let content = '===== æ—¥å¿—ç›®å½• =====\n';
            currentRenderedLogs.forEach((log, index) => {
                content += `${index + 1}. ${log.title}\n`;
            });

            content += '\n===== æ—¥å¿—æ­£æ–‡ =====\n\n';
            currentRenderedLogs.forEach((log, index) => {
                content += `ã€${index + 1}ã€‘${log.title}\n`;
                content += `æ ‡ç­¾ï¼š${log.tags.join('ã€') || 'æ— '}\n`;
                content += `å‘å¸ƒæ—¶é—´ï¼š${log.time}\n`;
                content += `å†…å®¹ï¼š\n${log.content}\n\n`;
                content += '-------------------------\n\n';
            });

            // ç”Ÿæˆæ–‡ä»¶å¹¶ä¸‹è½½
            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            saveAs(blob, `æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}.txt`);
        }

        // å¯¼å‡ºä¸ºPDFï¼ˆç›®å½•ä¸å¯ç‚¹å‡»ï¼Œå‰ç«¯è½»é‡æ–¹æ¡ˆé™åˆ¶ï¼‰
        function exportAsPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // è®¾ç½®å­—ä½“ï¼ˆè§£å†³ä¸­æ–‡æ˜¾ç¤ºé—®é¢˜ï¼‰
            pdf.setFont('simhei', 'normal');
            pdf.setFontSize(16);
            pdf.text('æˆ‘çš„åšå®¢æ—¥å¿—', 95, 20, { align: 'center' });

            // ç›®å½•éƒ¨åˆ†
            pdf.setFontSize(14);
            pdf.text('===== æ—¥å¿—ç›®å½• =====', 20, 40);
            let yPos = 50;
            currentRenderedLogs.forEach((log, index) => {
                if (yPos > 280) { // åˆ†é¡µ
                    pdf.addPage();
                    yPos = 20;
                }
                pdf.text(`${index + 1}. ${log.title}`, 25, yPos);
                yPos += 10;
            });

            // æ­£æ–‡éƒ¨åˆ†
            pdf.addPage();
            pdf.setFontSize(14);
            pdf.text('===== æ—¥å¿—æ­£æ–‡ =====', 20, 20);
            yPos = 30;

            currentRenderedLogs.forEach((log, index) => {
                if (yPos > 280) {
                    pdf.addPage();
                    yPos = 20;
                }
                // æ ‡é¢˜
                pdf.setFontSize(12);
                pdf.text(`ã€${index + 1}ã€‘${log.title}`, 20, yPos);
                yPos += 8;
                // æ ‡ç­¾å’Œæ—¶é—´
                pdf.setFontSize(10);
                pdf.text(`æ ‡ç­¾ï¼š${log.tags.join('ã€') || 'æ— '} | å‘å¸ƒæ—¶é—´ï¼š${log.time}`, 20, yPos);
                yPos += 8;
                // å†…å®¹ï¼ˆåˆ†è¡Œå¤„ç†ï¼‰
                pdf.setFontSize(10);
                const contentLines = pdf.splitTextToSize(log.content, 170); // å®½åº¦170mm
                pdf.text(contentLines, 20, yPos);
                yPos += contentLines.length * 6 + 10; // è¡Œé«˜6mmï¼Œé—´è·10mm
                // åˆ†éš”çº¿
                pdf.setLineWidth(0.1);
                pdf.line(20, yPos, 190, yPos);
                yPos += 10;
            });

            // ä¸‹è½½PDF
            pdf.save(`æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}.pdf`);
        }

        // å¯¼å‡ºä¸ºEPUBï¼ˆç›®å½•å¯ç‚¹å‡»ï¼‰
        function exportAsEPUB() {
            // æ„å»ºEPUBç»“æ„ï¼šç›®å½•+æ­£æ–‡
            const epubOptions = {
                title: `æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}`,
                author: 'ä¸ªäººåšå®¢',
                publisher: 'ä¸ªäººåšå®¢ç³»ç»Ÿ',
                lang: 'zh-CN',
                content: []
            };

            // ç¬¬ä¸€æ­¥ï¼šæ·»åŠ ç›®å½•é¡µ
            let tocContent = '<h1>æ—¥å¿—ç›®å½•</h1><ul>';
            currentRenderedLogs.forEach((log, index) => {
                tocContent += `<li><a href="#log-${index}">${index + 1}. ${log.title}</a></li>`;
            });
            tocContent += '</ul>';

            epubOptions.content.push({
                title: 'ç›®å½•',
                data: tocContent
            });

            // ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ¯ä¸ªæ—¥å¿—çš„æ­£æ–‡é¡µï¼ˆå¸¦é”šç‚¹ï¼‰
            currentRenderedLogs.forEach((log, index) => {
                const logContent = `
                    <div id="log-${index}">
                        <h2>${index + 1}. ${log.title}</h2>
                        <p><strong>æ ‡ç­¾ï¼š</strong>${log.tags.join('ã€') || 'æ— '}</p>
                        <p><strong>å‘å¸ƒæ—¶é—´ï¼š</strong>${log.time}</p>
                        <div style="margin-top: 20px; line-height: 1.8;">${log.content.replace(/\n/g, '<br>')}</div>
                    </div>
                    <hr style="margin: 30px 0;">
                `;

                epubOptions.content.push({
                    title: log.title,
                    data: logContent
                });
            });

            // ç”ŸæˆEPUBå¹¶ä¸‹è½½
            const epubGenerator = new EpubGen(epubOptions);
            epubGenerator.generateEPUB().then((epubBlob) => {
                saveAs(epubBlob, `æˆ‘çš„åšå®¢æ—¥å¿—_${new Date().toLocaleDateString()}.epub`);
            }).catch((err) => {
                alert(`EPUBå¯¼å‡ºå¤±è´¥ï¼š${err.message}`);
                console.error(err);
            });
        }

        // ç»‘å®šäº‹ä»¶ï¼ˆæ–°å¢å–æ¶ˆç¼–è¾‘æŒ‰é’®äº‹ä»¶ï¼‰
        publishBtn.addEventListener('click', publishLog);
        cancelEditBtn.addEventListener('click', cancelEdit); // æ–°å¢
        dateSearchBtn.addEventListener('click', filterLogsByDate);
        searchBtn.addEventListener('click', searchLogs);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLogs();
        });

        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', () => {
            checkEnv();
            initVoiceRecognition();
            renderLogs(logs);
            renderTags();
        });

        // æš´éœ²å…¨å±€å‡½æ•°ï¼ˆä¾›æŒ‰é’®è°ƒç”¨ï¼‰
        window.editLog = editLog;
        window.deleteLog = deleteLog;
    </script>
</body>
</html>
